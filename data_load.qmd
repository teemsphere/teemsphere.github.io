# Loading data

## Overview

The `ems_data()` function loads and prepares GTAP database files for use in CGE model runs.
It handles the three core GTAP data files (dat, par, and set) and can optionally convert between GTAP v6.2 and v7.0 formats.
This function is also used to input any time steps (for temporally dynamic models), load set mappings for sets that are read into the model (i.e., not constructed from set operations), and incorporate auxiliary data via `ems_aux()`.

## Function signature

```r
ems_data(dat_input, par_input, set_input, time_steps = NULL,
         aux_input = NULL, target_format = NULL, ...)
```

| Argument | Type | Description |
|----------|------|-------------|
| `dat_input` | Character | Path to a HAR file containing basedata coefficient data |
| `par_input` | Character | Path to a HAR file containing parameter coefficient data |
| `set_input` | Character | Path to a HAR file containing set elements and attributes |
| `time_steps` | Integer vector or `NULL` | Time steps for intertemporal models (see [Time steps]) |
| `aux_input` | List or `NULL` | Auxiliary data created with `ems_aux()` (see [Auxiliary inputs]) |
| `target_format` | Character or `NULL` | Target data format conversion: `"GTAPv6"` or `"GTAPv7"` |
| `...` | Named arguments | Set mappings for read-in sets (see [Set mappings]) |

All three input files (`dat_input`, `par_input`, `set_input`) are required.

## Input files
Compatible input files are currently limited to those produced by the Global Trade Analysis Project [(GTAP)](https://www.gtap.agecon.purdue.edu/).
Although the most recent database releases are proprietary, GTAP has consistently open-accessed databases two versions out (GTAP 9 database as of the current GTAP 11 release).
In order to access the freely available database, users will need to [register](https://www.gtap.agecon.purdue.edu/access_member/profile/profile_addnew.aspx) with GTAP and download the "FlexAgg" format.
For GTAP 9 this is accessible under the "GDyn 9 Data Base for 2011" subheader in the "Satellite Data and Utilities" section [here](https://www.gtap.agecon.purdue.edu/databases/archives.asp).
For paying GTAP members, the current [`teems`](https://github.com/teemsphere/teems-R) version is capable of handling the "FlexAgg" format for GTAP Databases 10 and 11.

At a minimum, the basedata "dat", parameter "par", and set "set" files are required inputs for the `dat_input`, `par_input`, and `set_input` arguments respectively.
```r
v7_data <- ems_data(dat_input = "path/to/flexAgg11c17/gsdfdat.har", # basedata coefficients
                    par_input = "path/to/flexAgg11c17/gsdfpar.har", # parameter coefficients
                    set_input = "path/to/flexAgg11c17/gsdfset.har", # set elements
                    REG = "big3",
                    COMM = "macro_sector",
                    ACTS = "macro_sector",
                    ENDW = "labor_diff"
)
```
Note that the actual names of the files vary according the GTAP release.

| Input Type | GTAP v9 | GTAP v10 | GTAP v11 |
|------------|---------|----------|----------|
| dat_input  | gddat.har | gsddat.har | gsdfdat.har |
| par_input  | gdpar.har | gsdpar.har | gsdfpar.har |
| set_input  | gdset.har | gsdset.har | gsdfset.har |


## Set mappings
In addition to input files, set mappings for sets that are read in from the final sets input file must be provided.
Read-in sets consist of sets that in the model Tablo file contain a "read" qualifier.
For example, the region set below requires a set mapping to be loaded:

```
Set
    REG # regions #
    read elements from file GTAPSETS header "REG";
```
while the non-margin set below is constructed from sets previous declared (read-in in the case of the standard [GTAPv7.0](https://github.com/teemsphere/teems-models/blob/main/GTAPv7.0/GTAPv7.0.tab)) and therefore requires no mapping.
```
Set
    NMRG # non-margin commodities # = COMM - MARG;
```

[`teems`](https://github.com/teemsphere/teems-R) ships with a number of set mappings for read-in sets ranging in size and focus.
These internal mappings may be immediately utilized or a user may input their own mapping. Internal mappings are identified by the absence of a ".csv" file extension and inputted as a character string.
Internal region mappings are as follows with the AR5, WB7, and WB23 derived from the [countrycode](https://vincentarelbundock.github.io/countrycode/#/man/codelist) R package - (ar5, region, and region23 respectively).

- region (e.g., `REG`)
  - big3 (China, United States, ROW)
  - AR5 (IPCC Fifth Assessment Report)
  - WB7 (World Bank 7 region)
  - WB23 (World Bank 23 region)
  - R32 (IIASA-based 32 region [SSP mapping](https://tntcat.iiasa.ac.at/SspDb/dsd?Action=htmlpage&page=10))
  - medium
  - large
  - full

Internal sector mappings are according to the following focuses and number of elements:

- sector (e.g., `TRAD_COMM`, `COMM`, `ACTS`)
  - macro_sector
  - agriculture
  - manufacturing
  - services
  - medium
  - full

The set names used in `...` depend on the data format. For example the GTAP v6.2 model format uses `REG`, `TRAD_COMM`, and `ENDW_COMM`:

```r
v62_data <- ems_data(dat_input = "path/to/flexagg10AY14/gsddat.har",
                     par_input = "path/to/flexagg10AY14/gsdpar.har",
                     set_input = "path/to/flexagg10AY14/gsdset.har",
                     REG = "big3",            # China, USA, ROW
                     TRAD_COMM = "macro_sector", # crops, food, livestock, mnfcs, svces
                     ENDW_COMM = "labor_agg"     # capital, labor, land, natlres
)
```

while the GTAP v7.0 model format uses `REG`, `COMM`, `ACTS`, and `ENDW`:

```r
v7_data <- ems_data(dat_input = "path/to/flexAgg11c17/gsdfdat.har",
                    par_input = "path/to/flexAgg11c17/gsdfpar.har",
                    set_input = "path/to/flexAgg11c17/gsdfset.har",
                    REG = "AR5",
                    COMM = "agriculture",
                    ACTS = "agriculture",
                    ENDW = "labor_diff"
)
```

Note that margin sectors are not inputted directly, rather inferred from choice of sectoral aggregation.
The default margin sector elements at full aggregation are "atp", "otp", and "wtp" representing air, other, and water transport.
If services are aggregated, these elements will be aggregated into the larger "service" sector while a mapping such as "medium" aggregates these into a single transport sector.
The default margin sector elements can be viewed and modified using `ems_option_get()` and `ems_option_set()`:

```r
ems_option_get("margin_sectors")
ems_option_set(margin_sectors = c("atp", "otp", "wtp"))
```

Internal endowment mappings currently include `labor_agg` (aggregated labor endowments), `labor_diff` (aggregated labor along skilled/unskilled delineation), and `full`.
All internal mappings by data format, database version, and set can be viewed here: [teems-mappings](https://github.com/teemsphere/teems-mappings).

### External mappings

External mappings may be provided in the form of a filepath to a two column csv file where the first column represents origin elements and the second column represents mapped (aggregated) elements.
See [teems-mappings](https://github.com/teemsphere/teems-mappings) for example mappings.

```r
v7_data <- ems_data(dat_input = "path/to/flexagg10AY14/gsddat.har",
                    par_input = "path/to/flexagg10AY14/gsdpar.har",
                    set_input = "path/to/flexagg10AY14/gsdset.har",
                    REG = "path/to/custom_REG_mapping.csv",
                    COMM = "macro_sector",
                    ACTS = "macro_sector",
                    ENDW = "labor_agg"
)
```


## Auxiliary inputs {#auxiliary-inputs}

The `ems_aux()` function loads and prepares auxiliary data for injection into the `ems_data()` pipeline via the `aux_input` argument.
Auxiliary data can replace existing headers or introduce novel headers not present in the original database.
All auxiliary data is loaded at full (unaggregated) resolution and is subsequently aggregated by `ems_data()` according to the set mappings and data type.

### Function signature

```r
ems_aux(dat = NULL, par = NULL, set = NULL)
```

| Argument | Type | Description |
|----------|------|-------------|
| `dat` | List or `NULL` | Auxiliary inputs for non-parameter coefficients (sum aggregation) |
| `par` | List or `NULL` | Auxiliary inputs for parameter coefficients (mean/weighted mean aggregation) |
| `set` | List or `NULL` | Under development |

At least one of `dat` or `par` must be provided.

### Input formats

Each parameter accepts a list whose elements can be in one of three formats:

**Named data frame** -- The list element name corresponds to the header. The data frame must contain a `Value` column alongside one or more set columns. The set columns identify the dimensions of the coefficient.

```r
# Extract and modify a header from ems_data output
d <- ems_data(
  dat_input = "path/to/gsddat.har",
  par_input = "path/to/gsdpar.har",
  set_input = "path/to/gsdset.har",
  REG = "full",
  TRAD_COMM = "full",
  ENDW_COMM = "labor_agg",
  time_steps = c(0, 1, 2, 3, 4, 6, 8, 10, 12, 14, 16)
)

pop <- d$POP
class(pop) <- "data.frame"

# Modify values
SAVE <- pop
SAVE$Value <- runif(nrow(SAVE))
```

**Named CSV file** -- The list element name corresponds to the header and the value is a file path to a CSV file formatted identically to the data frame format above (set columns + `Value` column).

```r
pop_csv <- "path/to/pop.csv"
write.csv(pop, pop_csv, row.names = FALSE)
```

**Unnamed HAR file** -- An unnamed list element containing a file path to a GTAP header array (`.har`) file. All headers within the file are loaded.

```r
har_file <- "path/to/gdpextra.har"
```

### Constructing auxiliary inputs

These formats can be mixed freely within a single `ems_aux()` call. The `dat` and `par` arguments control how the data is aggregated downstream: `dat` inputs undergo simple sum aggregation while `par` inputs undergo mean or weighted mean aggregation.

```r
aux <- ems_aux(
  dat = list(POP = pop_csv,          # CSV file for POP header
             SAVE = SAVE,            # data frame for SAVE header
             VTWR = d$VTWR,          # data.table directly from ems_data
             rndm = d$VTWR),         # novel header with same structure
  par = list(POP = pop_csv,          # same header can appear in both
             har_file)               # unnamed HAR path loads all headers
)
```

### Using auxiliary data in `ems_data()`

The output of `ems_aux()` is passed directly to the `aux_input` argument of `ems_data()`:

```r
.data <- ems_data(
  dat_input = "path/to/gsddat.har",
  par_input = "path/to/gsdpar.har",
  set_input = "path/to/gsdset.har",
  aux_input = aux,
  REG = "big3",
  COMM = "macro_sector",
  ACTS = "macro_sector",
  ENDW = "labor_agg",
  time_steps = c(0, 1, 2, 3, 4, 6, 8, 10, 12, 14, 16)
)
```

When `ems_data()` processes auxiliary input, it merges the auxiliary data into the loaded database before aggregation. Headers that match existing database headers are validated for dimensional consistency -- the replacement data must have the same dimensions and contain all elements present in the original. Novel headers (those not in the original database) are matched against loaded sets by name and element membership.

### Replacement vs. novel headers

**Replacement headers** directly overwrite an existing header. The auxiliary data must have the same dimensions and include all elements found in the original data. For example, providing a modified `POP` header replaces the population data loaded from the basedata HAR file.

**Novel headers** introduce data not present in the original database. The set columns of the data frame are matched against sets loaded from the set input file. If a column name exactly matches a loaded set, its elements are validated. If the column name does not match but its elements are a subset of a known set, `teems` will issue a warning and rename the dimension accordingly.


## Time steps
For temporally dynamic models (e.g., [GTAP-INT](https://github.com/teemsphere/teems-models/tree/main/GTAP-INTv1), [GTAP-RE](https://github.com/teemsphere/teems-models/tree/main/GTAP-REv1)), time steps must be provided representing t0 plus actual year steps from t0.
Time steps can be inputted in either actual year increments or represented as chronological years.
Note that if chronological years are used, t0 must correspond with the reference year of the database being used.

Explicit time steps (equivalent to `c(2014, 2015, 2016, 2017, 2018, 2020, 2022, 2024, 2026, 2028, 2030)`) due to reference year associated with the loaded data inputs.
```r
data <- ems_data(dat_input = "path/to/flexagg10AY14/gsddat.har",
                 par_input = "path/to/flexagg10AY14/gsdpar.har",
                 set_input = "path/to/flexagg10AY14/gsdset.har",
                 REG = "WB23",
                 TRAD_COMM = "services",
                 ENDW_COMM = "labor_agg",
                 time_steps = c(0, 1, 2, 3, 4, 6, 8, 10, 12, 14, 16)
)
```

Chronological time steps (note reference year of input data)
```r
data <- ems_data(dat_input = "path/to/flexAgg11c17/gsdfdat.har",
                 par_input = "path/to/flexAgg11c17/gsdfpar.har",
                 set_input = "path/to/flexAgg11c17/gsdfset.har",
                 REG = "R32",
                 COMM = "medium",
                 ACTS = "medium",
                 ENDW = "labor_diff",
                 time_steps = c(2017, 2018, 2020, 2022, 2024, 2026, 2028, 2030)
)
```
## Converting formats
GTAP databases are available in the classic v6.2 and standard v7.0 formats, corresponding to the classic and standard [GTAP models](https://www.gtap.agecon.purdue.edu/models/current.asp).
If you wish to use a classic-based model with newer GTAP databases or vice-versa, `target_format` will convert the underlying database.
Note that set mappings are to be specified according to the model to be used, *not* the original format of inputted data.

GTAP 11 database converted to v6.2 data format:
```r
v62_data <- ems_data(dat_input = "path/to/flexAgg11c17/gsdfdat.har",
                     par_input = "path/to/flexAgg11c17/gsdfpar.har",
                     set_input = "path/to/flexAgg11c17/gsdfset.har",
                     REG = "big3",
                     TRAD_COMM = "macro_sector",
                     ENDW_COMM = "labor_agg",
                     target_format = "GTAPv6"
)
```

GTAP 10 v6.2 database converted to v7.0 data format:
```r
v7_data <- ems_data(dat_input = "path/to/flexagg10AY14/gsddat.har",
                    par_input = "path/to/flexagg10AY14/gsdpar.har",
                    set_input = "path/to/flexagg10AY14/gsdset.har",
                    REG = "AR5",
                    COMM = "macro_sector",
                    ACTS = "macro_sector",
                    ENDW = "labor_agg",
                    target_format = "GTAPv7"
)
```
## Data aggregation
Data is aggregated according to type, with non-parameter coefficients summed by target set mappings and weighted averages calculated for the parameters below.
A simple mean is applied to parameters not listed below.
If custom parameter values are desired, these can be loaded in their final format into the [`ems_model()`](https://teemsphere.github.io/model_load.html) function.

### GTAP v6.2 format parameter weight methodology

::: {.table-scroll .table-wide}
|                        | Header | Description                                          | Set Index                                                                 |
|------------------------|--------|------------------------------------------------------|---------------------------------------------------------------------------|
| **Param.**             |        |                                                      |                                                                           |
| $\sigma_\text{d}$      | ESBD   | Armington CES for domestic/imported allocation       | $i \in \text{TRAD\_COMM}$                                                 |
| $\sigma_\text{m}$      | ESBM   | Armington CES for regional allocation of imports     | $i \in \text{TRAD\_COMM}$                                                 |
| $\sigma_\text{va}$     | ESBV   | CES between primary factors in production            | $j \in \text{PROD\_COMM}$                                                 |
| $\gamma$               | INCP   | CDE expansion parameter                              | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |
| $\beta$                | SUBP   | CDE substitution parameter                           | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |
| **Data**               |        |                                                      |                                                                           |
|                        | EVFA   | Endowments – Firms purchases at agents' prices       | $i \in \text{ENDW\_COMM},\ j \in \text{PROD\_COMM},\ r \in \text{REG}$   |
|                        | VDFA   | Inter. – Firms' domestic purchases at agents' prices | $i \in \text{TRAD\_COMM},\ j \in \text{PROD\_COMM},\ r \in \text{REG}$   |
|                        | VDGA   | Inter. – Government domestic purchases at agents'    | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |
|                        | VDPA   | Inter. – Household domestic purchases at agents'     | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |
|                        | VIFA   | Inter. – Firms' imports at agents' prices            | $i \in \text{TRAD\_COMM},\ j \in \text{PROD\_COMM},\ r \in \text{REG}$   |
|                        | VIGA   | Inter. – Government imports at agents' prices        | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |
|                        | VIPA   | Inter. – Household imports at agents' prices         | $i \in \text{TRAD\_COMM},\ r \in \text{REG}$                             |

: Headers, descriptions, and index ranges for parameters and associated data within the GTAP v6.2 model. GTAP-INT v6.2 weights are identical to GTAP v6.2 with the addition of an invariant time set. {#tbl-v62-parameters}
:::

$$
\hat{\sigma}_{\text{d}_i} =
\frac{
\sum_{i}^{i^*}
\left(
\sigma_{\text{d}_i}
\sum_r
(vdpa_{i,r} + vdga_{i,r} + vdfa_{i,r} + vipa_{i,r} + viga_{i,r} + vifa_{i,r})
\right)
}
{
\sum_{i,r}^{i^*}
(vdpa_{i,r} + vdga_{i,r} + vdfa_{i,r} + vipa_{i,r} + viga_{i,r} + vifa_{i,r})
}
$$ {#eq-sigmaD}

$$
\hat{\sigma}_{\text{m}_i} =
\frac{
\sum_{i}^{i^*}
\left(
\sigma_{\text{m}_i}
\sum_r
(vipa_{i,r} + viga_{i,r} + vifa_{i,r})
\right)
}
{
\sum_{i,r}^{i^*}
(vipa_{i,r} + viga_{i,r} + vifa_{i,r})
}
$$ {#eq-sigmaM}

$$
\hat{\sigma}_{\text{va}_j} =
\begin{cases}
\displaystyle
\frac{
\sum_{j}^{j^*}
\left(
\sigma_{\text{va}_j}
\sum_r evfa_{j,r}
\right)
}{
\sum_{j,r}^{j^*} evfa_{j,r}
}
& \text{if } j \neq cgds \\
\sigma_{\text{va}_j}
& \text{if } j = cgds
\end{cases}
$$ {#eq-sigmaVA}

$$
\hat{\gamma}_{i,r} =
\frac{
\sum_{i,r}^{i^* r^*}
\gamma_{i,r}
\sum_{i,r} (vdpa_{i,r} + vipa_{i,r})
}{
\sum_{i,r}^{i^* r^*}
(vdpa_{i,r} + vipa_{i,r})
}
$$ {#eq-gamma}

$$
\hat{\beta}_{i,r} =
\frac{
\sum_{i,r}^{i^* r^*}
\left(
\beta_{i,r}
\sum_{i,r} (vdpa_{i,r} + vipa_{i,r})
\right)
}{
\sum_{i,r}^{i^* r^*}
(vdpa_{i,r} + vipa_{i,r})
}
$$ {#eq-beta}

### GTAP v7.0 format parameter weight methodology

::: {.table-scroll .table-wide}
|                        | Header | Description                                           | Set Index                                      |
|------------------------|--------|-------------------------------------------------------|------------------------------------------------|
| **Param.**             |        |                                                       |                                                |
| $\sigma_\text{d}$  | ESBD   | Armington CES for domestic/imported allocation        | $c \in \text{COMM}$                            |
| $\sigma_\text{m}$  | ESBM   | Armington CES for regional allocation of imports      | $c \in \text{COMM}$                            |
| $\sigma_\text{va}$ | ESBV   | CES between primary factors in production             | $a \in \text{ACTS},\ r \in \text{REG}$         |
| $\gamma$               | INCP   | CDE expansion parameter                               | $c \in \text{COMM},\ r \in \text{REG}$         |
| $\beta$                | SUBP   | CDE substitution parameter                            | $c \in \text{COMM},\ r \in \text{REG}$         |
| **Data**               |        |                                                       |                                                |
|                        | EVFP   | Primary factor purchases at purchasers' prices        | $e \in \text{ENDW},\ a \in \text{ACTS},\ r \in \text{REG}$ |
|                        | VDFP   | Domestic purchases by firms at purchasers' prices     | $c \in \text{COMM},\ a \in \text{ACTS},\ r \in \text{REG}$ |
|                        | VDGP   | Domestic purchases by government at purchasers' prices| $c \in \text{COMM},\ r \in \text{REG}$         |
|                        | VDPP   | Domestic purchases by households at purchasers' prices| $c \in \text{COMM},\ r \in \text{REG}$         |
|                        | VMFP   | Import purchases by firms at purchasers' prices       | $c \in \text{COMM},\ a \in \text{ACTS},\ r \in \text{REG}$ |
|                        | VMGP   | Import purchases by government at purchasers' prices  | $c \in \text{COMM},\ r \in \text{REG}$         |
|                        | VMPP   | Import purchases by households at purchasers' prices  | $c \in \text{COMM},\ r \in \text{REG}$         |

: Headers, descriptions, and index ranges for parameters and associated data within the GTAP v7 model. {#tbl-v7-parameters}
:::

$$
\hat{\sigma}_{\text{d}_{c}} = \frac{\sum_{c}^{c^{*}}\left(\sigma_{\text{d}_{c}}\sum_{r} (vdpp_{c,r} + vmpp_{c,r} + vdgp_{c,r} + vmgp_{c,r} + vdfp_{c,r} + vmfp_{c,r})\right)}
                    {\sum_{c,r}^{c^{*}} (vdpp_{c,r} + vmpp_{c,r} + vdgp_{c,r} + vmgp_{c,r} + vdfp_{c,r} + vmfp_{c,r})}
$$ {#eq-sigmaD-v7}

$$
\hat{\sigma}_{\text{m}_{c}} = \frac{\sum_{c}^{c^{*}}\left(\sigma_{\text{m}_{c}}\sum_{r} (vmpp_{c,r} + vmgp_{c,r} + vmfp_{c,r})\right)}
      {\sum_{c,r}^{c^{*}} (vmpp_{c,r} + vmgp_{c,r} + vmfp_{c,r})}
$$ {#eq-sigmaM-v7}

$$
\hat{\sigma}_{\text{va}_{a}} = \frac{\sum_{a}^{a^{*}}\left(\sigma_{\text{va}_{a}}\sum_{r} evfp_{a,r}\right)}
                               {\sum_{a,r}^{a^{*}} evfp_{a,r}}
$$ {#eq-sigmaVA-v7}

$$
\hat{\gamma}_{c,r} = \frac{\sum_{c,r}^{c^{*}r^{*}}\gamma_{c,r}\sum_{c,r} (vdpp_{c,r} + vmpp_{c,r})}
      {\sum_{c,r}^{c^{*}r^{*}} (vdpp_{c,r} + vmpp_{c,r})}
$$ {#eq-gamma-v7}

$$
\hat{\beta}_{c,r} = \frac{\sum_{c,r}^{c^{*}r^{*}}\left(\beta_{c,r}\sum_{c,r} (vdpp_{c,r} + vmpp_{c,r})\right)}
      {\sum_{c,r}^{c^{*}r^{*}} (vdpp_{c,r} + vmpp_{c,r})}
$$ {#eq-beta-v7}